{"title":"SQL执行计划","date":"2020-12-10T14:07:31.000Z","date_formatted":{"ll":"Dec 10, 2020","L":"12/10/2020","MM-DD":"12-10"},"link":"2020/12/10/SQL执行计划","tags":["ORACLE"],"categories":["读书笔记"],"updated":"2020-12-13T14:45:06.254Z","content":"<h2 id=\"解释计划\">解释计划<a title=\"#解释计划\" href=\"#解释计划\"></a></h2>\n<p>TODO</p>\n<h2 id=\"执行计划\">执行计划<a title=\"#执行计划\" href=\"#执行计划\"></a></h2>\n<p>当一条SQL语句执行时会生成该语句的实际执行计划，在语句被硬解析后，所选执行计划会被存到库高速缓存方便下次使用。</p>\n<h3 id=\"查看最近生成的sql语句\">查看最近生成的SQL语句<a title=\"#查看最近生成的sql语句\" href=\"#查看最近生成的sql语句\"></a></h3>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- SCOTT替换成实际用户名</span></span><br><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"comment\">/* recentsql */</span> sql_id,child_number,hash_value,address,executions,sql_text</span><br><span class=\"line\"><span class=\"keyword\">FROM</span> v$<span class=\"keyword\">sql</span></span><br><span class=\"line\"><span class=\"keyword\">WHERE</span> parsing_user_id = (</span><br><span class=\"line\">        <span class=\"keyword\">SELECT</span> user_id <span class=\"keyword\">FROM</span> all_users</span><br><span class=\"line\">        <span class=\"keyword\">WHERE</span> username = <span class=\"string\">&#x27;SCOTT&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">AND</span> command_type <span class=\"keyword\">IN</span> (<span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">6</span>,<span class=\"number\">7</span>,<span class=\"number\">189</span>)</span><br><span class=\"line\">    <span class=\"keyword\">AND</span> <span class=\"keyword\">upper</span>(sql_text) <span class=\"keyword\">NOT</span> <span class=\"keyword\">LIKE</span> <span class=\"keyword\">upper</span>(<span class=\"string\">&#x27;%recentsql%&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<h3 id=\"查看相关执行计划\">查看相关执行计划<a title=\"#查看相关执行计划\" href=\"#查看相关执行计划\"></a></h3>\n<p>在sqlplus下查看</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">-- sql加上/*+ gather_plan_statistics */注释</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"comment\">/*+ gather_plan_statistics */</span> empno,ename <span class=\"keyword\">from</span> emp <span class=\"keyword\">where</span> ename = <span class=\"string\">&#x27;KING&#x27;</span>;</span><br><span class=\"line\"><span class=\"comment\">-- 关闭SERVEROUTPUT</span></span><br><span class=\"line\"><span class=\"keyword\">set</span> serveroutput <span class=\"keyword\">off</span></span><br><span class=\"line\"><span class=\"comment\">-- 查看执行计划</span></span><br><span class=\"line\"><span class=\"keyword\">select</span> * <span class=\"keyword\">from</span> <span class=\"keyword\">table</span>(dbms_xplan.display_cursor(<span class=\"literal\">null</span>,<span class=\"literal\">null</span>,<span class=\"string\">&#x27;ALLSTATS LAST&#x27;</span>));</span><br></pre></td></tr></table></figure>\n<p>结果如下表：\u0014</p>\n<div class=\"φcy\"><div class=\"φda\"><table><thead>\n<tr>\n<th>Id</th>\n<th>Operation</th>\n<th>Name</th>\n<th>Starts</th>\n<th>E-Rows</th>\n<th>A-Rows</th>\n<th>A-Time</th>\n<th>Buffers</th>\n<th>Reads</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>SELECT STATEMENT</td>\n<td></td>\n<td>1</td>\n<td></td>\n<td>1</td>\n<td>00:00:00.01</td>\n<td>8</td>\n<td>6</td>\n</tr>\n<tr>\n<td>1</td>\n<td>TABLE ACCESS FULL</td>\n<td>EMP</td>\n<td>1</td>\n<td>1</td>\n<td>1</td>\n<td>00:00:00.01</td>\n<td>8</td>\n<td>6</td>\n</tr>\n</tbody>\n</table></div></div><p>各个表头的含义：</p>\n<ul>\n<li>A-Rows:返回多少行</li>\n<li>Buffers:发生了多少次一致性读取</li>\n<li>Reads:发生了多少次物理读取</li>\n<li>Starts:每一步骤执行的次数</li>\n</ul>\n<h3 id=\"标识sql语句以便后续取回计划\">标识SQL语句以便后续取回计划<a title=\"#标识sql语句以便后续取回计划\" href=\"#标识sql语句以便后续取回计划\"></a></h3>\n<ol>\n<li>通过注释标识SQL</li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span> <span class=\"comment\">/* KM-EMPTEST */</span> <span class=\"comment\">/*+ gather_plan_statistics */</span> empno,ename <span class=\"keyword\">FROM</span> emp <span class=\"keyword\">WHERE</span> job = <span class=\"string\">&#x27;MANAGER&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>使用如下脚本为任何SQL语句取出执行计划</li>\n</ol>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">SELECT</span></span><br><span class=\"line\">    xplan.*</span><br><span class=\"line\"><span class=\"keyword\">FROM</span></span><br><span class=\"line\">    (</span><br><span class=\"line\">        <span class=\"keyword\">SELECT</span></span><br><span class=\"line\">            <span class=\"keyword\">MAX</span>(sql_id) <span class=\"keyword\">KEEP</span>(<span class=\"keyword\">DENSE_RANK</span> <span class=\"keyword\">LAST</span> <span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> last_active_time) sql_id,</span><br><span class=\"line\">            <span class=\"keyword\">MAX</span>(child_number) <span class=\"keyword\">KEEP</span>(<span class=\"keyword\">DENSE_RANK</span> <span class=\"keyword\">LAST</span> <span class=\"keyword\">ORDER</span> <span class=\"keyword\">BY</span> last_active_time) child_number</span><br><span class=\"line\">        <span class=\"keyword\">FROM</span></span><br><span class=\"line\">            v$<span class=\"keyword\">sql</span></span><br><span class=\"line\">        <span class=\"keyword\">WHERE</span></span><br><span class=\"line\">            <span class=\"keyword\">upper</span>(sql_text) <span class=\"keyword\">LIKE</span> <span class=\"string\">&#x27;%&amp;1%&#x27;</span></span><br><span class=\"line\">            <span class=\"keyword\">AND</span> <span class=\"keyword\">upper</span>(sql_text) <span class=\"keyword\">NOT</span> <span class=\"keyword\">LIKE</span> <span class=\"string\">&#x27;%FROM V$SQL WHERE UPPER(SQL_TEXT) LIKE%&#x27;</span></span><br><span class=\"line\">    ) sqlinfo,</span><br><span class=\"line\">    <span class=\"keyword\">TABLE</span> ( dbms_xplan.display_cursor(sqlinfo.sql_id, sqlinfo.child_number, <span class=\"string\">&#x27;ALLSTATS LAST&#x27;</span>) ) xplan</span><br><span class=\"line\">/</span><br></pre></td></tr></table></figure>\n","prev":{"title":"2021","link":"2021/01/03/2021/2021"},"next":{"title":"hexo 基础模板","link":"2020/11/23/hello"},"plink":"https://marshmallowl.github.io/2020/12/10/SQL执行计划/","toc":[{"id":"解释计划","title":"解释计划","index":"1"},{"id":"执行计划","title":"执行计划","index":"2","children":[{"id":"查看最近生成的sql语句","title":"查看最近生成的SQL语句","index":"2.1"},{"id":"查看相关执行计划","title":"查看相关执行计划","index":"2.2"},{"id":"标识sql语句以便后续取回计划","title":"标识SQL语句以便后续取回计划","index":"2.3"}]}],"copyright":{"author":"liugs","link":"<a href=\"https://marshmallowl.github.io/2020/12/10/SQL执行计划/\" title=\"SQL执行计划\">https://marshmallowl.github.io/2020/12/10/SQL执行计划/</a>","license":"(<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"nofollow\" target=\"_blank\">CC BY-NC-SA 4.0</a>)许可协议，转载请注明来源<a href=\"https://marshmallowl.github.io/\" rel=\"nofollow\" target=\"_blank\">liugs</a>！"}}