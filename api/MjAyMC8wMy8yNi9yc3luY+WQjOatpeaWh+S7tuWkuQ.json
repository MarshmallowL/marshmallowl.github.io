{"title":"rsync同步备份","date":"2020-03-26T08:02:06.000Z","date_formatted":{"ll":"Mar 26, 2020","L":"03/26/2020","MM-DD":"03-26"},"link":"2020/03/26/rsync同步文件夹","tags":["util"],"categories":["工具"],"updated":"2021-04-03T05:30:52.339Z","content":"<h2 id=\"文章来源\">文章来源<a title=\"#文章来源\" href=\"#文章来源\"></a></h2>\n<ul>\n<li><a href=\"https://www.cnblogs.com/regit/p/8074221.html\" target=\"_blank\">rsync文件同步详解</a></li>\n<li><a href=\"http://blog.chinaunix.net/uid-11209572-id-3489986.html\" target=\"_blank\">linux配置rsync服务端</a></li>\n</ul>\n<h2 id=\"rsync简介\">rsync简介<a title=\"#rsync简介\" href=\"#rsync简介\"></a></h2>\n<blockquote>\n<p>rsync是linux系统下的数据镜像备份工具。使用快速增量备份工具Remote Sync可以远程同步，支持本地复制，或者与其他SSH、rsync主机同步。</p>\n</blockquote>\n<h2 id=\"安装rsync(centos默认安装了)\">安装rsync(centos默认安装了)<a title=\"#安装rsync(centos默认安装了)\" href=\"#安装rsync(centos默认安装了)\"></a></h2>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum -y install rsync</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">查看版本</span></span><br><span class=\"line\">rsync --version</span><br></pre></td></tr></table></figure>\n<h2 id=\"环境说明\">环境说明<a title=\"#环境说明\" href=\"#环境说明\"></a></h2>\n<ul>\n<li>\n<p>PC1: ==rsync服务端==，需要被备份的服务器，IP:192.168.80.14, 备份目录 /common</p>\n</li>\n<li>\n<p>PC2: ==rsync客户端==，备份服务器，用于存放备份文件（目录为/test），IP:192.168.80.15</p>\n</li>\n</ul>\n<h2 id=\"配置\">配置<a title=\"#配置\" href=\"#配置\"></a></h2>\n<ol>\n<li>首先登录PC1，编辑配置文件 <code>vim /etc/rsyncd.conf</code>, 配置文件如下</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置服务器信息提示文件，在该文件中编写提示信息</span></span><br><span class=\"line\">motd file = /etc/rsyncd.motd</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">开启rsync数据传输日志功能</span></span><br><span class=\"line\">transfer logging = yes</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置日志文件名，可通过<span class=\"built_in\">log</span> format参数设置日志格式</span></span><br><span class=\"line\">log file = /var/log/rsyncd.log</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置rsync进程号保存文件名称</span></span><br><span class=\"line\">pid file = /var/run/rsyncd.log</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置锁文件名称</span></span><br><span class=\"line\">lock file = /var/run/rsync.lock</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置服务器监听的端口号，默认是873</span></span><br><span class=\"line\">port = 873</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置本服务器所监听网卡接口的ip地址</span></span><br><span class=\"line\">address = 192.168.80.14</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置进行数据传输时所使用的帐户名或ID号,默认nobody</span></span><br><span class=\"line\">uid = nobody</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置进行数据传输时所使用的组名或GID号,默认nobody</span></span><br><span class=\"line\">gid = nobody</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">若为yes, rsync会首先进行chroot设置，将根映射在下面的path参数路径下，对客户端而言，系统的根就是path参数指定的路径。但这样做需要root权限，并且在同步符号连接资料时只会同步名称，不会同步内容。</span></span><br><span class=\"line\">use chroot = no</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">是否允许客户端上传数据，yes表示不允许</span></span><br><span class=\"line\">read only = yes</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置并发连接数，0表示无限制</span></span><br><span class=\"line\">max connections = 10</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">自定义模块名，rsync通过模块定义同步的目录，可定义多个</span></span><br><span class=\"line\">[common]</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">定义注释说明字串</span></span><br><span class=\"line\">comment = backup ftp</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">同步目录的真实路径通过path指定，该路径是指服务端需要备份的路径</span></span><br><span class=\"line\">path = /common</span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\">忽略一些IO错误</span></span><br><span class=\"line\">ignore errors</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">exclude = <span class=\"built_in\">test</span>/    <span class=\"comment\">#exclude指定common目录下某个目录可以不同步数据</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置允许连接服务器的账户，此账户可以是系统中不存在的用户</span></span><br><span class=\"line\">auth users = tom,jerry</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">密码验证文件名，该文件权限要求为只读，建议为600，仅在设置auth users后有效</span></span><br><span class=\"line\">secrets file = /etc/rsyncd.secrets</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">设置哪些主机可以同步数据，多ip和网段之间使用空格分隔</span></span><br><span class=\"line\">hosts allow = 192.168.80.0/255.255.255.0</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">除了hosts allow定义的主机外，拒绝其他所有</span></span><br><span class=\"line\">hosts deny = *</span><br><span class=\"line\"><span class=\"meta\"> #</span><span class=\"bash\">客户端请求显示模块列表时，本模块名称是否显示，默认为<span class=\"literal\">true</span></span></span><br><span class=\"line\">list = false</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>创建密码文件，PC1和PC2都需要操作</li>\n</ol>\n<p>==注意！客户端只需写入密码即可！！==</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;tom:123&quot; &gt; /etc/rsyncd.secrets</span><br><span class=\"line\">echo &quot;jerry:123&quot; &gt;&gt; /etc/rsyncd.secrets</span><br><span class=\"line\">chmod 600 /etc/rsyncd.secrets</span><br><span class=\"line\">echo &quot;welcome to access&quot; &gt; /etc/rsyncd.motd  #此项客户端不需要做</span><br><span class=\"line\">rsync --daemon    # --daemon表示后台执行，客户端开启rsync不需要--daemon选项</span><br><span class=\"line\">echo &quot;/usr/bin/rsync --daemon&quot; &gt;&gt; /etc/rc.local    #开机启动rsync服务</span><br><span class=\"line\">firewall-cmd --permanent --add-port=873/tcp    #添加防火墙规则，允许873端口的数据访问</span><br></pre></td></tr></table></figure>\n<ol start=\"3\">\n<li>查看rsync和se-linux相关的设置（==服务端设置==）</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">getsebool -a | grep rsync</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">如果rsync_export_all_ro是off,将其修改为on</span></span><br><span class=\"line\">setsebool -P rsync_export_all_ro on</span><br></pre></td></tr></table></figure>\n<ol start=\"4\">\n<li>rsync语法格式（==客户端执行==）</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -vzrtopg --progress tom@192.168.80.14::common /test     #通common模块指定的/common目录下的文件拷贝到本客户端的/test目录</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">参数说明</span></span><br><span class=\"line\">v:显示详细信息</span><br><span class=\"line\">z：传输过程中对数据进行压缩</span><br><span class=\"line\">r：递归</span><br><span class=\"line\">t：保留修改时间属性</span><br><span class=\"line\">o：保留文件所有者属性</span><br><span class=\"line\">p：保留文件权限属性</span><br><span class=\"line\">g：保留文件所属组属性</span><br><span class=\"line\">a：归档模式，主要保留文件属性，等同于-rlptgoD</span><br><span class=\"line\">--progress：显示数据传输的进度信息</span><br><span class=\"line\">--password-file=FILE：指定密码文件，将密码写入文件，实现非交互式数据同步，这个文件名也需要修改权限为600</span><br><span class=\"line\">--delete：删除那些仅在目标路径中存在的文件（源路径中不存在），在脚本中的数据同步经常加上此参数</span><br><span class=\"line\">--list-only：仅列出服务器模块列表，需要rsync服务器设置list=true</span><br></pre></td></tr></table></figure>\n<ol start=\"5\">\n<li>shell脚本（==客户端执行==）</li>\n</ol>\n<p><code>touch /backup-ftp.sh</code>  新建脚本</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">!/bin/bash</span></span><br><span class=\"line\">export PATH=/bin:/usr/bin:/usr/local/bin</span><br><span class=\"line\">SRC=common</span><br><span class=\"line\">DEST=/test/</span><br><span class=\"line\">server=192.168.80.14</span><br><span class=\"line\">user=tom</span><br><span class=\"line\">passfile=/etc/rsyncd.secrets</span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\"><span class=\"keyword\">if</span> the DEST directory not found, <span class=\"keyword\">then</span> create one</span></span><br><span class=\"line\">[ ! -d $DEST ] &amp;&amp; mkdir $DEST</span><br><span class=\"line\">[ ! -e $passfile ] &amp;&amp; exit 2</span><br><span class=\"line\">rsync -az --delete --password-file=$passfile $&#123;user&#125;@$&#123;server&#125;::$SRC $DEST</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ol start=\"6\">\n<li>加入定时任务</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">进入定时任务</span></span><br><span class=\"line\">crontab -e </span><br><span class=\"line\"><span class=\"meta\">#</span><span class=\"bash\">每隔6小时备份一次</span></span><br><span class=\"line\">* */6 * * * sh /backup-ftp.sh</span><br></pre></td></tr></table></figure>\n<p>以上为rsync备份基本流程，包括踩的一些坑，待有其他坑再补上</p>\n","prev":{"title":"下载指定路径的文件","link":"2020/04/28/下载指定路径的文件"},"plink":"https://marshmallowl.github.io/2020/03/26/rsync同步文件夹/","toc":[{"id":"文章来源","title":"文章来源","index":"1"},{"id":"rsync简介","title":"rsync简介","index":"2"},{"id":"安装rsync(centos默认安装了)","title":"安装rsync(centos默认安装了)","index":"3"},{"id":"环境说明","title":"环境说明","index":"4"},{"id":"配置","title":"配置","index":"5"}],"copyright":{"author":"liugs","link":"<a href=\"https://marshmallowl.github.io/2020/03/26/rsync同步文件夹/\" title=\"rsync同步备份\">https://marshmallowl.github.io/2020/03/26/rsync同步文件夹/</a>","license":"(<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"nofollow\" target=\"_blank\">CC BY-NC-SA 4.0</a>)许可协议，转载请注明来源<a href=\"https://marshmallowl.github.io/\" rel=\"nofollow\" target=\"_blank\">liugs</a>！"}}